<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Idea Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Inter, Arial, sans-serif;
      background: #f1f5f9;
      padding: 30px;
      max-width: 1200px;
      margin: auto;
    }

    h1 {
      margin-bottom: 12px;
    }

    .auth-container {
      max-width: 400px;
      margin: 50px auto;
      background: #fff;
      padding: 32px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .auth-container h2 {
      margin-bottom: 24px;
      text-align: center;
    }

    .auth-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
    }

    .auth-tabs button {
      flex: 1;
      padding: 10px;
      border: none;
      background: #e5e7eb;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 600;
    }

    .auth-tabs button.active {
      background: #2563eb;
      color: #fff;
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    input, textarea, button, select {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
    }

    button {
      background: #2563eb;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    button:hover {
      background: #1e40af;
    }

    button.secondary {
      background: #e5e7eb;
      color: #000;
    }

    button.secondary:hover {
      background: #d1d5db;
    }

    .error-msg {
      color: #dc2626;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .success-msg {
      color: #059669;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 20px;
    }

    form, .panel {
      background: #ffffff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .idea-card {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      border: 1px solid #e5e7eb;
    }

    .idea-card:hover {
      background: #f8fafc;
      border-color: #2563eb;
    }

    .idea-title {
      font-weight: 600;
    }

    .meta {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 11px;
      background: #e0e7ff;
      margin-right: 4px;
    }

    .rating {
      font-weight: bold;
      color: #2563eb;
    }

    .empty {
      color: #666;
      font-style: italic;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .logout-btn {
      width: auto;
      padding: 8px 16px;
    }

    .user-info {
      color: #666;
      font-size: 14px;
    }

    .button-group {
      display: flex;
      gap: 10px;
    }

    .button-group button {
      flex: 1;
    }

    .danger {
      background: #dc2626;
    }

    .danger:hover {
      background: #b91c1c;
    }
  </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="authScreen" class="auth-container">
  <h2>Idea Tracker</h2>

  <div class="auth-tabs">
    <button class="tab-btn active" data-tab="login">Login</button>
    <button class="tab-btn" data-tab="register">Register</button>
  </div>

  <!-- Login Form -->
  <form id="loginForm" class="auth-form active">
    <div id="loginError" class="error-msg"></div>
    <input type="text" id="loginUsername" placeholder="Username" required />
    <input type="password" id="loginPassword" placeholder="Password" required />
    <button type="submit">Login</button>
  </form>

  <!-- Register Form -->
  <form id="registerForm" class="auth-form">
    <div id="registerError" class="error-msg"></div>
    <input type="text" id="registerUsername" placeholder="Username" required />
    <input type="password" id="registerPassword" placeholder="Password (min 6 chars)" required minlength="6" />
    <input type="password" id="registerPasswordConfirm" placeholder="Confirm password" required />
    <button type="submit">Register</button>
  </form>
</div>

<!-- APP SCREEN -->
<div id="appScreen" style="display: none;">

  <div class="header">
    <div>
      <h1>Idea Tracker</h1>
      <div class="user-info">Logged in as: <strong id="currentUser"></strong></div>
    </div>
    <button class="logout-btn secondary" id="logoutBtn">Logout</button>
  </div>

  <div class="layout">

    <!-- LEFT: FORM + LIST -->
    <div>
      <form id="ideaForm">
        <input type="text" id="title" placeholder="Idea title" required />
        <textarea id="notes" rows="4" placeholder="Detailed notes..."></textarea>
        <input type="text" id="categories" placeholder="Categories (comma separated)" />
        <input type="number" id="excitement" min="1" max="10" placeholder="Excitement (1–10)" value="5" />
        <button type="submit">Save Idea</button>
      </form>

      <div id="ideaList"></div>
    </div>

    <!-- RIGHT: DETAIL VIEW -->
    <div class="panel" id="detailPanel">
      <div class="empty">Click an idea to view details</div>
    </div>

  </div>

</div>

<script>
  const API_BASE = window.location.origin;
  let authToken = localStorage.getItem("authToken");
  let currentUserId = localStorage.getItem("userId");
  let currentUsername = localStorage.getItem("username");
  let selectedIndex = null;

  const authScreen = document.getElementById("authScreen");
  const appScreen = document.getElementById("appScreen");

  // Show correct screen based on auth state
  function updateAuthUI() {
    if (authToken && currentUserId) {
      authScreen.style.display = "none";
      appScreen.style.display = "block";
      document.getElementById("currentUser").textContent = currentUsername;
      renderList();
    } else {
      authScreen.style.display = "block";
      appScreen.style.display = "none";
    }
  }

  // Tab switching
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", (e) => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".auth-form").forEach(f => f.classList.remove("active"));
      e.target.classList.add("active");
      document.getElementById(e.target.dataset.tab + "Form").classList.add("active");
    });
  });

  // Login handler
  document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const username = document.getElementById("loginUsername").value;
    const password = document.getElementById("loginPassword").value;
    const errorDiv = document.getElementById("loginError");

    try {
      const res = await fetch(`${API_BASE}/api/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();

      if (!res.ok) {
        errorDiv.textContent = data.error;
        return;
      }

      localStorage.setItem("authToken", data.token);
      localStorage.setItem("userId", data.userId);
      localStorage.setItem("username", data.username);
      authToken = data.token;
      currentUserId = data.userId;
      currentUsername = data.username;

      updateAuthUI();
      document.getElementById("loginForm").reset();
      errorDiv.textContent = "";
    } catch (error) {
      errorDiv.textContent = "Network error";
    }
  });

  // Register handler
  document.getElementById("registerForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const username = document.getElementById("registerUsername").value;
    const password = document.getElementById("registerPassword").value;
    const confirm = document.getElementById("registerPasswordConfirm").value;
    const errorDiv = document.getElementById("registerError");

    if (password !== confirm) {
      errorDiv.textContent = "Passwords do not match";
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();

      if (!res.ok) {
        errorDiv.textContent = data.error;
        return;
      }

      localStorage.setItem("authToken", data.token);
      localStorage.setItem("userId", data.userId);
      localStorage.setItem("username", data.username);
      authToken = data.token;
      currentUserId = data.userId;
      currentUsername = data.username;

      updateAuthUI();
      document.getElementById("registerForm").reset();
      errorDiv.textContent = "";
    } catch (error) {
      errorDiv.textContent = "Network error";
    }
  });

  // Logout handler
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("authToken");
    localStorage.removeItem("userId");
    localStorage.removeItem("username");
    authToken = null;
    currentUserId = null;
    currentUsername = null;
    updateAuthUI();
  });

  // API helpers
  async function apiCall(method, endpoint, body = null) {
    const options = {
      method,
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${authToken}`
      }
    };
    if (body) options.body = JSON.stringify(body);

    const res = await fetch(`${API_BASE}${endpoint}`, options);
    if (res.status === 401) {
      localStorage.removeItem("authToken");
      updateAuthUI();
      return null;
    }
    return res.json();
  }

  async function renderList() {
    const ideas = await apiCall("GET", "/api/ideas");
    if (!ideas) return;

    const ideaList = document.getElementById("ideaList");
    ideaList.innerHTML = "";

    ideas.forEach((idea, index) => {
      const div = document.createElement("div");
      div.className = "idea-card";
      div.onclick = () => showDetail(idea, index);

      const categories = Array.isArray(idea.categories) ? idea.categories : [];
      div.innerHTML = `
        <div class="idea-title">${idea.title}</div>
        <div class="meta">
          ${categories.map(c => `<span class="badge">${c}</span>`).join("")}
          <span class="rating">★ ${idea.excitement}</span>
        </div>
      `;
      ideaList.appendChild(div);
    });
  }

  function showDetail(idea, index) {
    selectedIndex = idea.id;
    const categories = Array.isArray(idea.categories) ? idea.categories : [];

    const detailPanel = document.getElementById("detailPanel");
    detailPanel.innerHTML = `
      <h3>${idea.title}</h3>
      <p>${idea.notes || "No notes added."}</p>

      <h4>Categories</h4>
      ${categories.map(c => `<span class="badge">${c}</span>`).join("")}

      <h4>Excitement</h4>
      <p class="rating">${idea.excitement}/10</p>

      <div class="button-group">
        <button onclick="enterEditMode(${JSON.stringify(idea).replaceAll('"', '&quot;')})">Edit</button>
        <button class="danger" onclick="deleteIdea(${idea.id})">Delete</button>
      </div>
    `;
  }

  async function enterEditMode(idea) {
    const categories = Array.isArray(idea.categories) ? idea.categories : [];
    const detailPanel = document.getElementById("detailPanel");

    detailPanel.innerHTML = `
      <h3>Edit Idea</h3>

      <input id="editTitle" value="${idea.title.replaceAll('"', '&quot;')}" />
      <textarea id="editNotes" rows="4">${(idea.notes || "").replaceAll('"', '&quot;')}</textarea>
      <input id="editCategories" value="${categories.join(", ")}" />
      <input id="editExcitement" type="number" min="1" max="10" value="${idea.excitement}" />

      <div class="button-group">
        <button onclick="saveEdit(${idea.id})">Save</button>
        <button class="secondary" onclick="renderList(); showDetail(${JSON.stringify(idea).replaceAll('"', '&quot;')}, 0)">Cancel</button>
      </div>
    `;
  }

  async function saveEdit(ideaId) {
    const title = document.getElementById("editTitle").value;
    const notes = document.getElementById("editNotes").value;
    const categories = document.getElementById("editCategories").value
      .split(",")
      .map(c => c.trim())
      .filter(Boolean);
    const excitement = parseInt(document.getElementById("editExcitement").value);

    const result = await apiCall("PUT", `/api/ideas/${ideaId}`, {
      title,
      notes,
      categories,
      excitement
    });

    if (result && result.success) {
      renderList();
    }
  }

  async function deleteIdea(ideaId) {
    if (!confirm("Are you sure you want to delete this idea?")) return;

    const result = await apiCall("DELETE", `/api/ideas/${ideaId}`);
    if (result && result.success) {
      renderList();
      document.getElementById("detailPanel").innerHTML = '<div class="empty">Click an idea to view details</div>';
    }
  }

  // Form submission
  document.getElementById("ideaForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = document.getElementById("title").value;
    const notes = document.getElementById("notes").value;
    const categories = document.getElementById("categories").value
      .split(",")
      .map(c => c.trim())
      .filter(Boolean);
    const excitement = parseInt(document.getElementById("excitement").value);

    const result = await apiCall("POST", "/api/ideas", {
      title,
      notes,
      categories,
      excitement
    });

    if (result && result.id) {
      document.getElementById("ideaForm").reset();
      document.getElementById("excitement").value = "5";
      renderList();
    }
  });

  // Initialize
  updateAuthUI();
</script>

</body>
</html>
